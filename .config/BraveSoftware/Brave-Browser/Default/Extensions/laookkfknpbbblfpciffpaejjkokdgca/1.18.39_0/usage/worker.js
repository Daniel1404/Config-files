!function(t){var e={};function n(o){if(e[o])return e[o].exports;var r=e[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(o,r,function(e){return t[e]}.bind(null,r));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){t.exports=n(1)},function(t,e,n){let o;o=n(2).default,self.addEventListener("connect",t=>{t.ports[0].onmessage=function(t){const e=t.data,n=e.func,r=e.params;o[n](...r)}})},function(t,e,n){"use strict";n.r(e);const o="http://momentumdash.com/local-cache-key/";var r={uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){let e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))},getFromCache:async function(t){const e=await caches.open("modash-cache"),n=await e.match(o+t);let r=null;return n&&(r=await n.json()),r},setCache:async function(t,e){const n=await caches.open("modash-cache");await n.put(o+t,new Response(e))},deleteCache:async function(t){const e=await caches.open("modash-cache");await e.delete(o+t)},activeDateStringForDate:function(t){let e=new Date(t);return e.getHours()<4&&(e=new Date(e.getTime()-864e5)),e.getFullYear().toString()+"-"+this.twoDigit(e.getMonth()+1)+"-"+this.twoDigit(e.getDate())},getActiveDateString:function(){return this.activeDateStringForDate(new Date)},twoDigit:function(t){let e=parseInt(t);return(e>=10?e:"0"+e.toString()).toString()}},c=function(){let t=null,e=null;const n={READY:"ready",UPLOADING:"uploading",UPLOADED:"uploaded"};function o(){try{const n=indexedDB.open("momo-db",1);n.onsuccess=function(){t=n.result},n.onupgradeneeded=function(o){!function(n,o){try{n.oncomplete=function(){t=o},e=o.createObjectStore("usage",{keyPath:"key"}),e.createIndex("ready",["forDate","itemUuid","status"])}catch(t){console.error(t)}}(o.target.transaction,n.result)}}catch(t){console.error(t)}}function c(){return new Promise((function(e,n){try{t?e(t):(o(),setTimeout((function(){c().then((function(t){e(t)}))}),10))}catch(t){n(t)}}))}return{status:n,increment:function(t,e,o,a){let i=null;c().then((function(c){try{const u=c.transaction(["usage"],"readwrite"),s=r.getActiveDateString();u.objectStore("usage").index("ready").get([s,t,n.READY]).onsuccess=function(n){try{i=void 0===n.target.result?g.create(t,e):n.target.result,Array.isArray(o)||(o=[o]),o.forEach((function(t){i[t]++})),u.objectStore("usage").put(i),a&&a(n.target.result)}catch(t){console.error(t)}}}catch(t){console.error(t)}}))},saveEntity:function(t){const e={};return Object.assign(e,t),e.key=r.uuidv4(),e.status=n.READY,new Promise((function(t,n){c().then((function(o){try{const r=o.transaction(["usage"],"readwrite");r.oncomplete=function(e){t(e)},r.onerror=function(t){n(t)},r.objectStore("usage").put(e)}catch(t){n(t)}}))}))},prepareUnsynced:function(){return new Promise((function(t,e){c().then((function(o){try{const r=o.transaction(["usage"],"readwrite");r.oncomplete=function(){t(u)};const c=(new Date).getTime(),a=c-6e4,i=r.objectStore("usage"),u=[];let s=50;i.openCursor().onsuccess=function(t){try{let e=t.target.result;if(e&&s>0){if(e.value.status===n.READY||e.value.uploadDate<a){s--;const t=e.value;t.status=n.UPLOADING,t.uploadDate=c,e.update(t).onsuccess=function(){u.push(t)}}e.continue()}}catch(t){e()}}}catch(t){e()}})).catch((function(){e()}))}))},cleanSynced:function(t){return new Promise((function(e,n){c().then((function(o){try{const r=o.transaction(["usage"],"readwrite");r.oncomplete=function(){e()},r.objectStore("usage").openCursor().onsuccess=function(e){try{const n=e.target.result;n&&(t.map((function(t){n.value.key===t&&n.delete()})),n.continue())}catch(t){n(t)}}}catch(t){n(t)}})).catch((function(){n()}))}))}}}();let a=null,i=null,u=null,s=null;const l="Photo",d={PHOTO:1,QUOTE:2,MANTRA:3,ERROR:4,SEARCH:5,STATS:6,TIMING:7,SYSTEM:8,PHOTO_LOAD:9},f={IMPRESSION_COUNT:"impressionCount",HOVER_COUNT:"hoverCount",LOAD_COUNT:"loadCount",CLICK_COUNT:"clickCount",SECONDARY_CLICK_COUNT:"secondaryClickCount",ADMIRE_COUNT:"admireCount",STICKY_CLICK_COUNT:"stickyClickCount",STICKY_SECONDARY_CLICK_COUNT:"stickySecondaryClickCount",STICKY_HOVER_COUNT:"stickyHoverCount"},C={[d.PHOTO]:[f.IMPRESSION_COUNT,f.HOVER_COUNT,f.LOAD_COUNT,f.ADMIRE_COUNT,f.CLICK_COUNT,f.STICKY_CLICK_COUNT,f.SECONDARY_CLICK_COUNT,f.STICKY_SECONDARY_CLICK_COUNT,f.STICKY_HOVER_COUNT],[d.QUOTE]:[f.IMPRESSION_COUNT,f.HOVER_COUNT,f.LOAD_COUNT,f.CLICK_COUNT]},O={updateInterval:6e4,["loaded"+d.PHOTO]:null,["loaded"+d.QUOTE]:null,["trackedLoaded"+d.PHOTO]:null,["trackedLoaded"+d.QUOTE]:null};const p={properties:f,types:d,create:function(t,e){const n={itemUuid:t,type:e,forDate:r.getActiveDateString(),status:c.status.READY,uploadDate:0,key:r.uuidv4()};return C[e].forEach((function(t){n[t]=0})),n},newTabLoaded:function(){O.loadComplete=!0,Object.values(d).forEach((function(t){const e=O["loaded"+t];e&&p.recordImpression(e,t)}))},setup:function(t,e,n,o){u=t,s=e,i=o,a=n,p.sendStats()},itemLoaded:function(t,e,n){O["loaded"+e]=t,!n&&O.loadComplete&&p.recordImpression(t,e)},savePhotoError:function(t){t.itemType=l,this.saveError(t,!0,!0)},saveError:function(t){t.type=d.ERROR,navigator.connection&&(t.rtt=navigator.connection.rtt,t.down=navigator.connection.downlink),this.save(t,!0,!0)},savePhotoLoad:function(t){t.type=d.PHOTO_LOAD,navigator.connection&&(t.rtt=navigator.connection.rtt,t.down=navigator.connection.downlink),this.save(t,!0,!1)},save:function(t,e,n){t.date=(new Date).getTime(),t.type||(t.type=d.STATS),c.saveEntity(t).then((function(){e&&!n&&p.sendStats()}))},increment:function(t,e,n,o){c.increment(t,e,n,(function(){o&&p.sendStats()}))},recordStickyHover:function(t,e){this.increment(t,e,[f.HOVER_COUNT,f.STICKY_HOVER_COUNT])},recordHover:function(t,e){this.increment(t,e,f.HOVER_COUNT)},recordClick:function(t,e,n){this.increment(t,e,f.CLICK_COUNT,n)},recordStickyClick:function(t,e,n){this.increment(t,e,[f.CLICK_COUNT,f.STICKY_CLICK_COUNT],n)},recordSecondaryClick:function(t,e,n){this.increment(t,e,f.SECONDARY_CLICK_COUNT,n)},recordStickySecondaryClick:function(t,e,n){this.increment(t,e,[f.SECONDARY_CLICK_COUNT,f.STICKY_SECONDARY_CLICK_COUNT],n)},recordImpression:function(t,e){this.increment(t,e,f.IMPRESSION_COUNT)},recordAdmire:function(t){this.increment(t,d.PHOTO,f.ADMIRE_COUNT)},sendStats:function(){O.sendingScheduled=!1,a&&(O.sending?O.sendingScheduled=!0:(O.sending=!0,setTimeout(async()=>{const t=await c.prepareUnsynced();await async function(t){try{if(!t||0===t.length||!navigator.onLine)return void(O.sending=!1);let e=await r.getFromCache("usage-retry-after");if(e){if((new Date).getTime()<parseInt(e))return void(O.sending=!1);e=null}t.forEach(t=>{C[t.type]&&C[t.type].forEach(e=>{0===t[e]&&delete t[e]}),isNaN(t.type)&&(t.type=t.type===p.types.PHOTO?1:2),delete t.status,delete t.uploadDate});const n=await fetch(u+"collect",{method:"post",headers:y(),body:JSON.stringify(t)});if(n.ok){let t=await n.json();t&&await c.cleanSynced(t),setTimeout(()=>{O.sendingScheduled&&p.sendStats()},2e3)}else if(503===n.status){let t=n.headers.get("Retry-After");t&&(t=parseInt(t),r.setCache("usage-retry-after",(new Date).getTime()+1e3*t))}}catch(t){console.error(t)}finally{O.sending=!1}}(t)},1e3)))}};function y(){const t={"Content-Type":"application/json","X-Momentum-Version":s};return i&&(t.Authorization="Bearer "+i),a&&(t["X-Momentum-ClientId"]=a),t}setInterval(p.sendStats,O.updateInterval);var g=e.default=p}]);
//# sourceMappingURL=worker.js.map